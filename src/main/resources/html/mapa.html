<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Mapa Interactivo</title>

    <!-- Referencia correcta a Leaflet -->
    <link rel="stylesheet" href="leaflet.css" />
    <style>
        html, body { margin: 0; padding: 0; height: 100%; }
        #map { width: 100%; height: 100%; }
    </style>
</head>
<body>
<div id="map"></div>

<!-- Cargar Leaflet JS -->
<script src="leaflet.js"></script>
<script>
    // Inicialización del mapa centrado en Bogotá
    var map = L.map('map').setView([4.6097, -74.0817], 6);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Capas
    var marcadoresLayer = L.layerGroup().addTo(map);
    var rutasLayer = L.layerGroup().addTo(map);
    var caminoLayer = L.layerGroup().addTo(map);

    // Arreglos para almacenar info
    var ubicaciones = [];
    var rutas = [];

    /** Agrega un marcador avanzado con popup y color según urgencia */
    function agregarMarcadorAvanzado(lat, lon, nombre, popupHTML, color) {
        var marker = L.circleMarker([lat, lon], {
            color: color,
            radius: 8,
            fillOpacity: 0.8
        }).bindPopup(popupHTML);
        marcadoresLayer.addLayer(marker);
        ubicaciones.push({lat: lat, lon: lon, nombre: nombre, urgencia: color});
    }

    /** Agrega una ruta entre dos puntos */
    function agregarRuta(lat1, lon1, lat2, lon2) {
        var ruta = L.polyline([[lat1, lon1], [lat2, lon2]], {color: 'green', weight: 3, opacity: 0.7});
        rutasLayer.addLayer(ruta);
        rutas.push([[lat1, lon1], [lat2, lon2]]);
    }

    /** Muestra el camino más corto en rojo (resalta) */
    function mostrarCaminoMasCorto(coordsArray, color='red') {
        limpiarCaminos();
        if(coordsArray.length === 0) return;
        caminoLayer = L.layerGroup().addTo(map);
        var poly = L.polyline(coordsArray, {color: color, weight: 5});
        caminoLayer.addLayer(poly);
    }

    /** Limpia el camino resaltado */
    function limpiarCaminos() {
        if(caminoLayer) {
            caminoLayer.clearLayers();
        }
    }

    /** Centra el mapa en una ubicación específica */
    function centrarEn(lat, lon) {
        map.setView([lat, lon], 14);
    }

    /** Carga todos los marcadores y rutas actuales en el mapa */
    function cargarMarcadoresYRutas() {
        marcadoresLayer.clearLayers();
        rutasLayer.clearLayers();

        // Marcadores
        ubicaciones.forEach(u => {
            var marker = L.circleMarker([u.lat, u.lon], {
                color: u.urgencia,
                radius: 8,
                fillOpacity: 0.8
            }).bindPopup(u.nombre);
            marcadoresLayer.addLayer(marker);
        });

        // Rutas
        rutas.forEach(r => {
            L.polyline(r, {color: 'green', weight: 3, opacity: 0.7}).addTo(rutasLayer);
        });
    }
</script>
</body>
</html>
